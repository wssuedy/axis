var nedb = require("nedb");

module.exports = function(domain, dbnames) {

  function cb() {}
  var dbs = {};
  dbnames.forEach(name => {
    dbs[name] = new nedb()
  });

  domain.on({
    type: "create"
  }, function(event) {
    let {
      actorType,
      data
    } = event.json;

    let db = dbs[actorType];
    if (db) {
      db.insert(data, cb);
    }
  });

  domain.on({
    type: "remove"
  }, function(event) {

    const {
      actorType,
      actorId
    } = event.json;
    let db = dbs[actorType];
    if (db) {
      db.remove({
        id: actorId
      }, {}, cb);
    }
  });

  domain.on({}, function(event) {
    const {
      actorType,
      updatedData,
      type,
      actorId
    } = event.json;
    if (!(type === "remove" || type === "create")) {
      let db = dbs[actorType];
      if (db) {
        db.update({
          id: actorId
        }, {
          $set: updatedData
        }, {}, cb);
      }
    }
  });

  return dbs;
}
